# Audit Report - 2026-02-01

## Summary
- üî¥ Critical Issues: 1
- üü° Warnings: 3
- üü¢ Suggestions: 2

## üî¥ Critical Issues (High Priority)
1. **Weak Default Secret Key (Security)**
   - **File:** `api_server.py` (Line 45)
   - **Problem:** The app uses a default hardcoded secret key `dev-secret-key-change-in-production` if the environment variable is missing.
   - **Risk:** If deployed without setting `FLASK_SECRET_KEY`, attackers can sign their own session cookies, leading to full account takeover.
   - **Fix:** Remove the default value or raise an error if `FLASK_SECRET_KEY` is not set in production.

## üü° Warnings (Medium Priority)
1. **Permissive CORS Policy (Security)**
   - **File:** `api_server.py` (Line 53)
   - **Problem:** `origins` defaults to `*` (allow all).
   - **Risk:** Allows any malicious website to communicate with your API if the user's browser is authenticated (though with API keys this is less critical, it's still bad practice for internal tools).
   - **Fix:** Restrict `CORS_ORIGINS` to specific domains (e.g., `http://localhost:3000`, `https://your-domain.com`).

2. **N+1 API Call Performance Bottleneck (Performance)**
   - **File:** `api_server.py` (Line 169-173) inside `sync_aims_data`
   - **Problem:** The code iterates through crew members and calls `get_crew_schedule` for **each one**.
   - **Impact:** SOAP calls are slow (e.g., 1s each). Syncing just 10 crew members takes ~10 seconds. Syncing 100 would take almost 2 minutes. The current code is hardcoded to limit to 10 members (`[:10]`), likely to avoid this timeout.
   - **Fix:** Investigate if AIMS API supports batch fetching (e.g. `CrewMemberRosterDetailsForPeriod` with multiple IDs or a "All Crew" flag) to reduce network round-trips.

3. **Monolithic API Structure (Code Quality)**
   - **File:** `api_server.py`
   - **Problem:** The file is over 1100 lines and contains all logic (Routes, Config, Scheduler, Helpers).
   - **Impact:** Hard to maintain and test. Merge conflicts will be frequent.
   - **Fix:** Refactor into Flask Blueprints (e.g., `routes/crew.py`, `routes/flights.py`).

## üü¢ Suggestions (Low Priority)
1. **Generic Error Handling**
   - **Problem:** Frequent use of `except Exception as e`.
   - **Improvement:** Catch specific exceptions (e.g., `ValueError`, `NetworkError`) to better handle different failure modes.

2. **Input Sanitization**
   - **Problem:** `bleach` is in requirements but not explicitly seen in use for sanitizing `request.args` inputs before logic (though Supabase driver handles SQL injection).
   - **Improvement:** Ensure strings displayed in HTML templates (if any) are sanitized.

## Next Steps
Use the AWF menu to proceed with fixes.

---

## üîß FIX ALL Results (2026-02-01 16:16)

### ‚úÖ ƒê√£ t·ª± ƒë·ªông s·ª≠a: 2 l·ªói
1. **Weak Secret Key** ‚Üí ƒê√£ th√™m validation: Server s·∫Ω crash n·∫øu ch·∫°y production m√† kh√¥ng set `FLASK_SECRET_KEY`.
2. **Permissive CORS** ‚Üí ƒê√£ ƒë·ªïi m·∫∑c ƒë·ªãnh t·ª´ `*` sang `localhost:5000` only.

### ‚ö†Ô∏è C·∫ßn x·ª≠ l√Ω th·ªß c√¥ng: 2 l·ªói
1. **N+1 API Call**: C·∫ßn ƒëi·ªÅu tra AIMS API xem c√≥ h·ªó tr·ª£ batch request kh√¥ng. N·∫øu kh√¥ng, c·∫ßn cache ho·∫∑c background sync.
2. **Monolithic Code**: C·∫ßn refactor `api_server.py` th√†nh Flask Blueprints (task l·ªõn, recommend d√πng `/refactor`).

### ‚ùå Kh√¥ng th·ªÉ auto-fix: 0 l·ªói
